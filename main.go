package main

import (
	"encoding/json"
	"fmt"
	"io/ioutil"
	"log"
	"net/http"

	"github.com/UD94/SecondOP/Common"
	"github.com/UD94/SecondOP/Function"
)

var channel_password string

type AutoGenerated struct {
	Password   string   `json:"Password"`
	Doldfile   bool     `json:"Doldfile"`
	Action     string   `json:"Action"`
	Domain     string   `json:"Domain"`
	Configtype string   `json:"Configtype"`
	Content    []string `json:"Content"`
}

func HandlePostJson(w http.ResponseWriter, r *http.Request) {
	// 根据请求body创建一个json解析器实例
	var get_result AutoGenerated
	data, err := ioutil.ReadAll(r.Body)

	json.Unmarshal(data, &get_result)
	if err != nil {
		return
	}

	if get_result.Password != channel_password {
		fmt.Fprintf(w, `{"code":5}`)
	} else {
		switch get_result.Action {
		case "dnsresolvr":
			go Function.Dns_thread(get_result.Domain)

			go Function.Google_domain(get_result.Domain)
			fmt.Fprintf(w, `{"code":0}`)
		case "config":
			Config_Workstation(get_result.Configtype, get_result.Content, get_result.Doldfile)
			fmt.Fprintf(w, `{"code":0}`)
		default:
			fmt.Fprintf(w, `{"code":0}`)
		}
	}

}

func Config_Workstation(configtype string, content []string, Doldfile bool) {
	switch configtype {
	case "dnsdomainconfig":
		if Doldfile {
			Common.DeleteFile("domain.txt")
		}
		for _, s := range content {
			Common.Write_result(s+"\n", "domain.txt")
		}

	default:
		return
	}
}

func Starthttps() {
	http.HandleFunc("/post", HandlePostJson)
	err := http.ListenAndServeTLS(":4321", "server.crt", "server.key", nil)
	if err != nil {
		log.Fatal("listen error:", err.Error())
	}
}

func main() {

	channel_password = "ud94iscreater"
	Common.Write_result("test.txt", "fff")

	Starthttps()
}
